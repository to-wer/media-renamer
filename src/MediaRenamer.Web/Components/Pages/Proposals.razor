@page "/proposals"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using MediaRenamer.Core.Models
@using MediaRenamer.Web.Services
@implements IAsyncDisposable
@inject ProposalClient Client

<PageTitle>MediaRenamer Proposals</PageTitle>
<h1 class="text-2xl font-bold mb-4">Media Rename Proposals</h1>

<!-- Mobile-first Table -->
<div class="glass-card overflow-x-auto rounded-2xl shadow-2xl">
  <table class="min-w-[800px] w-full divide-y divide-white/10">  <!-- min-width f√ºr Mobile-Scroll -->
    <thead class="bg-white/5 backdrop-blur-sm sticky top-0 z-10">
    <tr>
      <th class="px-6 py-4 text-left font-bold text-slate-200 text-sm uppercase tracking-wider">
        üìÅ Datei
      </th>
      <th class="px-6 py-4 text-left font-bold text-slate-200 text-sm uppercase tracking-wider">
        ‚ú® Vorschlag
      </th>
      <th class="px-6 py-4 text-center font-bold text-slate-200 text-sm uppercase tracking-wider hidden md:table-cell">
        üé¨ Typ
      </th>
      <th class="px-6 py-4 text-center font-bold text-slate-200 text-sm uppercase tracking-wider hidden lg:table-cell">
        üìÖ Jahr
      </th>
      <th class="px-6 py-4 text-center font-bold text-slate-200 text-sm uppercase tracking-wider">
        üîî Status
      </th>
      <th class="px-6 py-4 text-center font-bold text-slate-200 text-sm uppercase tracking-wider">
        ‚ö° Aktion
      </th>
    </tr>
    </thead>
    <tbody class="divide-y divide-white/5 bg-white/2 backdrop-blur-sm">
    @foreach (var p in _proposals)
    {
      <tr class="hover:bg-white/5 transition-all group">
        <!-- Datei: FULL Name, Icon -->
        <td class="px-6 py-5">
          <div class="flex items-center space-x-3">
            <div class="min-w-0 flex-1">
              <div class="font-mono text-slate-300 text-sm leading-tight">@Path.GetFileName(p.Source.OriginalPath)</div>
              <div class="text-xs text-slate-500 mt-0.5">@{ Path.GetDirectoryName(p.Source.OriginalPath); }</div>
            </div>
          </div>
        </td>

        <!-- Vorschlag: FULL Text, bold -->
        <td class="px-6 py-5 text-emerald-300 text-lg leading-tight">
          @p.ProposedName
        </td>

        <!-- Typ: Icon + Badge -->
        <td class="px-6 py-5 text-center hidden md:table-cell">
            <span
              class="inline-flex px-3 py-1.5 bg-white/10 backdrop-blur-sm rounded-full text-sm font-bold text-slate-200 shadow-md">
              @(p.Source.Type == MediaType.Movie ? "üé¨ Film" : "üì∫ Serie")
            </span>
        </td>

        <!-- Jahr: centered -->
        <td class="px-6 py-5 text-center hidden lg:table-cell text-lg font-bold text-slate-200">
          @p.Source.Year
        </td>

        <!-- Status: fixed, no wrap -->
        <td class="px-6 py-5 text-center whitespace-nowrap">
          @if (p.Status == ProposalStatus.Pending)
          {
            <span class="inline-flex px-4 py-2 bg-gradient-to-r from-yellow-500/20 to-amber-500/20 
                           text-yellow-300 border-2 border-yellow-500/40 rounded-xl text-sm font-bold 
                           shadow-lg animate-pulse">
                ‚è≥ Warten auf Approval
              </span>
          }
          else if (p.Status == ProposalStatus.Approved)
          {
            <span class="inline-flex px-4 py-2 bg-gradient-to-r from-emerald-500/20 to-teal-500/20 
                           text-emerald-300 border-2 border-emerald-500/40 rounded-xl text-sm font-bold 
                           shadow-lg">
                ‚úÖ Umbenannt
              </span>
          }
          else if (p.Status == ProposalStatus.Rejected)
          {
            <span class="inline-flex px-4 py-2 bg-gradient-to-r from-rose-500/20 to-pink-500/20 
                   text-rose-300 border-2 border-rose-500/40 rounded-xl text-sm font-bold 
                   shadow-lg">
              ‚ùå Abgelehnt
            </span>
          }
        </td>

        <!-- Buttons: immer nebeneinander -->
        <td class="px-6 py-5 text-center whitespace-nowrap">
          @if (p.Status == ProposalStatus.Pending)
          {
            <div class="flex gap-2 justify-center">
              <button class="btn-primary text-sm px-5 py-2.5 shadow-xl hover:shadow-2xl hover:scale-105 min-w-[80px]"
                      @onclick="() => Approve(p)">
                  <span class="inline-flex items-center gap-1">
                    ‚úÖ Approve
                  </span>
              </button>
              <button class="bg-gradient-to-r from-rose-500 to-pink-500 hover:from-rose-600 hover:to-pink-600 
                               text-white text-sm px-5 py-2.5 rounded-xl font-semibold shadow-xl hover:shadow-2xl 
                               hover:scale-105 transition-all duration-200 min-w-[80px]"
                      @onclick="() => Reject(p)">
                ‚ùå Reject
              </button>
            </div>
          }
          else
          {
            <span
              class="text-emerald-400 text-sm font-bold bg-emerald-500/10 px-4 py-2 rounded-xl border border-emerald-500/30">
                ‚úÖ Erledigt
              </span>
          }
        </td>
      </tr>
    }
    </tbody>
  </table>
</div>


@code {
  private List<RenameProposal> _proposals = new();
  private Timer? _timer;
  private bool _isLoading;

  protected override async Task OnInitializedAsync()
  {
    await LoadProposals();

    _timer = new(async _ =>
    {
      await InvokeAsync(async () =>
      {
        await LoadProposals();
        StateHasChanged();
      });
    }, null, 5000, 5000);
  }

  private async Task LoadProposals()
  {
    try
    {
      _proposals = await Client.GetProposalsAsync();
    }
    catch (Exception ex)
    {
      // Log oder Toast-Error
      Console.WriteLine($"LoadProposals Error: {ex.Message}");
    }
  }

  private async Task Approve(RenameProposal proposal)
  {
    await Client.ApproveAsync(proposal.Source.OriginalPath);
    await LoadProposals();
  }

  private async Task Reject(RenameProposal proposal)
  {
    await Client.RejectAsync(proposal.Source.OriginalPath);
    await LoadProposals();
  }

  public ValueTask DisposeAsync()
  {
    _timer?.DisposeAsync();
    return ValueTask.CompletedTask;
  }

  private async Task Refresh()
  {
    _isLoading = true;
    StateHasChanged();
    _proposals = await Client.GetProposalsAsync();
    _isLoading = false;
    StateHasChanged();
  }

}

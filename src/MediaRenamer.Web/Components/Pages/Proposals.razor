@page "/proposals"
@rendermode @(new InteractiveServerRenderMode(prerender: false))
@using MediaRenamer.Core.Models
@using MediaRenamer.Web.Services
@implements IAsyncDisposable
@inject ProposalClient Client
@inject IConfiguration Configuration

<PageTitle>MediaRenamer Proposals</PageTitle>
<h1 class="text-2xl font-bold mb-4">Media Rename Proposals</h1>

<!-- Tab Navigation -->
<div class="flex gap-2 mb-6">
    <button class="tab-btn @(_activeTabEquals("aktuell") ? "active" : "")" @onclick="SetAktuellTab">
        ðŸ“‹ Aktuell
        @if (_pendingCount > 0)
        {
            <span class="ml-2 px-2 py-0.5 bg-yellow-500/20 text-yellow-300 rounded-full text-xs font-bold">
                @_pendingCount
            </span>
        }
    </button>
    <button class="tab-btn @(_activeTabEquals("historie") ? "active" : "")" @onclick="SetHistorieTab">
        ðŸ“œ Historie
    </button>
</div>

@if (_activeTab == "aktuell")
{
    <!-- Aktuelle Liste: Pending + Zuletzt bearbeitete -->
    @if (_currentProposals.Count == 0)
    {
        <div class="glass-card p-8 text-center">
            <p class="text-slate-400 text-lg">âœ¨ Keine offenen VorschlÃ¤ge</p>
        </div>
    }
    else
    {
        <div class="mb-4 text-sm text-slate-400">
            Zeige @_pendingCount offene und @_recentlyProcessedCount zuletzt bearbeitete
        </div>
        <ProposalsTable Proposals="_currentProposals" OnApprove="Approve" OnReject="Reject" OnUpdateName="UpdateName" />
    }
}
else
{
    <!-- Historie: Alle bearbeiteten Proposals -->
    @if (_historyProposals.Count == 0)
    {
        <div class="glass-card p-8 text-center">
            <p class="text-slate-400 text-lg">ðŸ“­ Keine Historie vorhanden</p>
        </div>
    }
    else
    {
        <div class="mb-4 text-sm text-slate-400">
            @_historyProposals.Count EintrÃ¤ge in der Historie
        </div>
        <ProposalsTable Proposals="_historyProposals" OnApprove="Approve" OnReject="Reject" OnUpdateName="UpdateName" />
    }
}

@code {
    private List<RenameProposal> _currentProposals = new();
    private List<RenameProposal> _historyProposals = new();
    private List<RenameProposal> _allProposals = new();
    private Timer? _timer;
    private string _activeTab = "aktuell";
    private int _pendingCount;
    private int _recentlyProcessedCount;
    private const int RecentLimit = 10;

    private bool _activeTabEquals(string tab) => _activeTab == tab;
    private void SetAktuellTab() => _activeTab = "aktuell";
    private void SetHistorieTab() => _activeTab = "historie";

    protected override async Task OnInitializedAsync()
    {
        await LoadProposals();

        // TODO: make interval configurable -> same as scanning in api
        int period = Configuration.GetValue<int>("Media:ScanInterval");
        _timer = new Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadProposals();
                StateHasChanged();
            });
        }, null, 5000, period * 1000);
    }

    private async Task LoadProposals()
    {
        try
        {
            _allProposals = await Client.GetProposalsAsync();
            
            // Split into pending and processed
            var pending = _allProposals.Where(p => p.Status == ProposalStatus.Pending).OrderByDescending(p => p.ScanTime).ToList();
            var processed = _allProposals.Where(p => p.Status != ProposalStatus.Pending).OrderByDescending(p => p.ScanTime).ToList();
            
            _pendingCount = pending.Count;
            _recentlyProcessedCount = Math.Min(RecentLimit, processed.Count);
            
            // Current = pending + recently processed
            _currentProposals = pending.Take(50).Concat(processed.Take(RecentLimit)).OrderByDescending(p => p.ScanTime).ToList();
            
            // History = all processed
            _historyProposals = processed;
        }
        catch (Exception ex)
        {
            // Log oder Toast-Error
            Console.WriteLine($"LoadProposals Error: {ex.Message}");
        }
    }

    private async Task Approve(RenameProposal proposal)
    {
        await Client.ApproveAsync(proposal.Id);
        await LoadProposals();
    }

    private async Task Reject(RenameProposal proposal)
    {
        await Client.RejectAsync(proposal.Id);
        await LoadProposals();
    }

    private async Task UpdateName((RenameProposal Proposal, string NewName) args)
    {
        await Client.UpdateProposedNameAsync(args.Proposal.Id, args.NewName);
        await LoadProposals();
    }

    public ValueTask DisposeAsync()
    {
        _timer?.DisposeAsync();
        return ValueTask.CompletedTask;
    }

    private async Task Refresh()
    {
        await LoadProposals();
    }
}
